---
title: "Stress Week Analysis"
author: "Alexandra Lalor"
date: "2022-09-07"
output:
  html_document:
    theme: readable
    highlight: breezedark
    toc: yes
    toc_depth: 3
    toc_float:
      smooth_scroll: yes
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(ggplot2)
library(survival) #for km curve
library(ggfortify) #for km curve
opts_chunk$set(echo = FALSE, message = F, warning = F)
```

# Overview

A summary of Phase 1 Weight and Porometer Data

```{r}
#Weight

#read CSVs
Phase1_Data_Weight <- read_csv("data_analysis/Phase1_Data_Weight.csv")

#convert variables
Phase1_Data_Weight$Phase <- as.factor(Phase1_Data_Weight$Phase)
Phase1_Data_Weight$Chamber <- as.factor(Phase1_Data_Weight$Chamber)
Phase1_Data_Weight$ScientificName <- as.factor(Phase1_Data_Weight$ScientificName)
Phase1_Data_Weight$CommonName <- as.factor(Phase1_Data_Weight$CommonName)
Phase1_Data_Weight$Species <- as.factor(Phase1_Data_Weight$Species)
Phase1_Data_Weight$Treatment_temp <- as.factor(Phase1_Data_Weight$Treatment_temp)
Phase1_Data_Weight$Treatment_water <- as.factor(Phase1_Data_Weight$Treatment_water)
Phase1_Data_Weight$PorometerSubset <- as.factor(Phase1_Data_Weight$PorometerSubset)
Phase1_Data_Weight$Dead <- as.factor(Phase1_Data_Weight$Dead)
Phase1_Data_Weight$Heatwave_graph <- as.factor(Phase1_Data_Weight$Heatwave_graph)
Phase1_Data_Weight$Heatwave <- as.factor(Phase1_Data_Weight$Heatwave)

#filter NAs
Phase1_Data_Weight <- Phase1_Data_Weight %>% 
  filter(!is.na(Weight_Est))

```

```{r}
#Avg Weight

#read CSVs
Phase1_Data_Weight_Avg <- read_csv("data_analysis/Phase1_Data_Weight_Avg.csv")

#filter for drought
Phase1_Data_Weight_Avg <- Phase1_Data_Weight_Avg %>%
  filter(Treatment_water == "Drought")


#create stress week label
Weight_Stress_Label <- Phase1_Data_Weight_Avg %>% 
  filter(Treatment_temp == "Ambient") %>% 
  group_by(Species, Treatment_temp) %>% 
  summarize(Species = unique(Species),
            CommonName = ifelse(Species == "PIED", "Pinyon Pine",
                                ifelse(Species == "PIPO", "Ponderosa Pine",
                                       ifelse(Species == "PIFL", "Limber Pine",
                                              ifelse(Species == "PSME", "Douglas fir", "Engelman Spruce")))),
            Week = mean(Stress_Week_Avg_Weight, na.rm = T),
            xmin = min(Week),
            xmax = max(Week),
            Weight_Est = 0,
            WaterWeight_Calc = 0,
            ymin1 = 0,
            ymin2 = 200,
            ymax1 = 500,
            ymax2 = 1000)
Weight_Stress_Label <- Weight_Stress_Label %>% 
  group_by(Species) %>% 
  summarize(Species = unique(Species),
            CommonName = unique(CommonName),
            Week = mean(Week),
            xmin = min(xmin),
            xmax = max(xmax),
            Weight_Est = 0,
            WaterWeight_Calc = 0,
            ymin1 = 0,
            ymin2 = 200,
            ymax1 = 500,
            ymax2 = 1000)
```


```{r}
#Porometer

#read CSVs
Phase1_Data_Porometer <- read_csv("data_analysis/Phase1_Data_Porometer.csv")

#convert variables
Phase1_Data_Porometer$Phase <- as.factor(Phase1_Data_Porometer$Phase)
Phase1_Data_Porometer$Chamber <- as.factor(Phase1_Data_Porometer$Chamber)
Phase1_Data_Porometer$ScientificName <- as.factor(Phase1_Data_Porometer$ScientificName)
Phase1_Data_Porometer$CommonName <- as.factor(Phase1_Data_Porometer$CommonName)
Phase1_Data_Porometer$Species <- as.factor(Phase1_Data_Porometer$Species)
Phase1_Data_Porometer$Treatment_temp <- as.factor(Phase1_Data_Porometer$Treatment_temp)
Phase1_Data_Porometer$Treatment_water <- as.factor(Phase1_Data_Porometer$Treatment_water)
Phase1_Data_Porometer$PorometerSubset <- as.factor(Phase1_Data_Porometer$PorometerSubset)
Phase1_Data_Porometer$Dead <- as.factor(Phase1_Data_Porometer$Dead)
Phase1_Data_Porometer$Heatwave_graph <- as.factor(Phase1_Data_Porometer$Heatwave_graph)
Phase1_Data_Porometer$Heatwave <- as.factor(Phase1_Data_Porometer$Heatwave)

#filter for NAs
Phase1_Data_Porometer <- Phase1_Data_Porometer %>% 
  filter(!is.na(Porometer_Est)) %>% 
  mutate(Stress_Week_Porometer = ifelse(Treatment_water == "Watered", NA, Stress_Week_Porometer))
```

```{r}
#Avg Porometer

Phase1_Data_Porometer_Avg <- Phase1_Data_Porometer %>%
  group_by(ScientificName, CommonName, Species, Week, Treatment_temp, Treatment_water) %>% 
  summarize(Dead_Count = sum(Dead_Count),
            PercentDead = 100*(Dead_Count/20),
            Porometer_Est = mean(Porometer_Est, na.rm = T),
            Temperature_C = mean(Temperature_C, na.rm = T),
            LeafSensor_PercentRH = mean(LeafSensor_PercentRH, na.rm = T),
            FilterSensor_PercentRH = mean(FilterSensor_PercentRH, na.rm = T),
            SD_Avg = mean(SD_Porometer, na.rm = T),
            Stress_Week_Avg = round(mean(Stress_Week_Porometer, na.rm = TRUE), digits = 1)) %>% 
  arrange(Species, Week)

Phase1_Data_Porometer_Avg <- Phase1_Data_Porometer_Avg %>%
  filter(Treatment_water == "Drought")


#create stress week label
Porometer_Stress_Label <- Phase1_Data_Porometer_Avg %>% 
  filter(Treatment_temp == "Ambient") %>% 
  group_by(CommonName, Treatment_temp) %>% 
  summarize(CommonName = unique(CommonName),
            Week = mean(Stress_Week_Avg, na.rm = T),
            xmin = min(Week),
            xmax = max(Week),
            Porometer_Est = 0,
            ymin = 0, 
            ymax1 = 350,
            ymax2 = 600)
Porometer_Stress_Label <- Porometer_Stress_Label %>% 
  group_by(CommonName) %>% 
  summarize(CommonName = unique(CommonName),
            Week = mean(Week),
            xmin = min(xmin),
            xmax = max(xmax),
            Porometer_Est = 0,
            ymin = 0, 
            ymax1 = 350,
            ymax2 = 600)
```
 
```{r}
#All Data

#read csvs
Phase1_Data <- read_csv("data_QAQC/Phase1_Data.csv")

#convert variables
Phase1_Data$Phase <- as.factor(Phase1_Data$Phase)
Phase1_Data$Chamber <- as.factor(Phase1_Data$Chamber)
Phase1_Data$ScientificName <- as.factor(Phase1_Data$ScientificName)
Phase1_Data$CommonName <- as.factor(Phase1_Data$CommonName)
Phase1_Data$Species <- as.factor(Phase1_Data$Species)
Phase1_Data$Treatment_temp <- as.factor(Phase1_Data$Treatment_temp)
Phase1_Data$Treatment_water <- as.factor(Phase1_Data$Treatment_water)
Phase1_Data$PorometerSubset <- as.factor(Phase1_Data$PorometerSubset)
Phase1_Data$Dead <- as.factor(Phase1_Data$Dead)
Phase1_Data$Heatwave_graph <- as.factor(Phase1_Data$Heatwave_graph)
Phase1_Data$Heatwave <- as.factor(Phase1_Data$Heatwave)
```

```{r}
#Add stress week to All Data

#isolate weight stress week
Phase1_Data_Weight_add <- Phase1_Data_Weight %>% 
  mutate(Stress_Week_Weight = Stress_Week_Weight,
         Stress_Week_Avg_Weight = Stress_Week_Avg_Weight) %>% 
  select(c("SpeciesID", "Week", "Heatwave_graph","Stress_Week_Weight", "Stress_Week_Avg_Weight"))

#isolate porometer stress week
Phase1_Data_Porometer_add <- Phase1_Data_Porometer %>% 
  mutate(Stress_Week_Porometer = Stress_Week_Porometer,
         Stress_Week_Avg_Porometer = Stress_Week_Avg_Porometer) %>% 
  select(c("SpeciesID", "Week", "Heatwave_graph","Stress_Week_Porometer", "Stress_Week_Avg_Porometer"))

#add to main data
Phase1_Data_add <- merge(Phase1_Data_Porometer_add, Phase1_Data_Weight_add, all = T)
Phase1_Data <- merge(Phase1_Data, Phase1_Data_add, all = T)

# make sure averages are added for all plants
Phase1_Data <- Phase1_Data %>% 
  group_by(Heatwave_graph) %>% 
  mutate(Stress_Week_Avg_Weight = mean(Stress_Week_Avg_Weight, na.rm = T),
         Stress_Week_Avg_Porometer = mean(Stress_Week_Avg_Porometer, na.rm = T))

#start time using stress weeks
Phase1_Data <- Phase1_Data %>% 
  mutate(Stress_Week_Start_Avg_Weight = Week - Stress_Week_Avg_Weight,
         Stress_Week_Start_Avg_Porometer = Week - Stress_Week_Avg_Porometer)
```


### Summary
```{r}
Weight_Sum <- as.matrix(Phase1_Data_Weight %>% 
                          group_by(Heatwave_graph) %>% 
                          summarise(Weight_Stress_Week = round(mean(Stress_Week, na.rm = T), digits = 1)))

Porometer_Sum <- as.matrix(Phase1_Data_Porometer %>%
                             group_by(Heatwave_graph) %>%
                             summarise(Porometer_Stress_Week = round(mean(Stress_Week, na.rm = T), digits = 1)))

Summary <- merge(Weight_Sum, Porometer_Sum, by = "Heatwave_graph")
Summary$Weight_Stress_Week <- as.double(Summary$Weight_Stress_Week)
Summary$Porometer_Stress_Week <- as.double(Summary$Porometer_Stress_Week)

kable(Summary %>% 
        group_by(Heatwave_graph) %>% 
        summarize(Weight_Stress_Week = Weight_Stress_Week,
                  Porometer_Stress_Week = Porometer_Stress_Week,
                  Difference = Porometer_Stress_Week - Weight_Stress_Week))
```


# Weight Graphs

### All Weights
#### Comparing Weights of Droughted vs Watered Indiviudals
```{r}
Phase1_Data_Weight %>% 
  ggplot(aes(x = Week,
             y = Weight_g,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - All Species") +
  theme_minimal()

```

Black dotted lines show stress weeks for each individual, calculated using the inflection point of each curve.
Yellow dotted lines show average stress weeks for each treatment group (heatwave and ambient).
```{r}
# PIPO
Phase1_Data_Weight_PIPO <- Phase1_Data_Weight %>% 
  filter(Species == "PIPO")

Phase1_Data_Weight_PIPO %>% 
  ggplot(aes(x = Week,
             y = Weight_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Weight_PIPO$Stress_Week, 
           xend = Phase1_Data_Weight_PIPO$Stress_Week,
           y = 200, yend = 1000,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Weight_PIPO$Stress_Week_Avg,
           xend = Phase1_Data_Weight_PIPO$Stress_Week_Avg,
           y = 200, yend = 1000,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - Ponderosa Pine",
       caption = "Black dotted lines show drought stress point per individual (inflection point)\nYellow dotted line shows average drought stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PIED
Phase1_Data_Weight_PIED <- Phase1_Data_Weight %>% 
  filter(Species == "PIED")

Phase1_Data_Weight_PIED %>% 
  ggplot(aes(x = Week,
             y = Weight_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Weight_PIED$Stress_Week, 
           xend = Phase1_Data_Weight_PIED$Stress_Week,
           y = 200, yend = 1000,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Weight_PIED$Stress_Week_Avg,
           xend = Phase1_Data_Weight_PIED$Stress_Week_Avg,
           y = 200, yend = 1000,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - Pinyon Pine",
       caption = "Black dotted lines show drought stress point per individual (inflection point)\nYellow dotted line shows average drought stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()

```

```{r}
# PIFL
Phase1_Data_Weight_PIFL <- Phase1_Data_Weight %>% 
  filter(Species == "PIFL")

Phase1_Data_Weight_PIFL %>% 
  ggplot(aes(x = Week,
             y = Weight_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Weight_PIFL$Stress_Week, 
           xend = Phase1_Data_Weight_PIFL$Stress_Week,
           y = 200, yend = 1000,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Weight_PIFL$Stress_Week_Avg,
           xend = Phase1_Data_Weight_PIFL$Stress_Week_Avg,
           y = 200, yend = 1000,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - Limber Pine",
       caption = "Black dotted lines show drought stress point per individual (inflection point)\nYellow dotted line shows average drought stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PSME
Phase1_Data_Weight_PSME <- Phase1_Data_Weight %>% 
  filter(Species == "PSME")

Phase1_Data_Weight_PSME %>% 
  ggplot(aes(x = Week,
             y = Weight_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Weight_PSME$Stress_Week, 
           xend = Phase1_Data_Weight_PSME$Stress_Week,
           y = 200, yend = 1000,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Weight_PSME$Stress_Week_Avg,
           xend = Phase1_Data_Weight_PSME$Stress_Week_Avg,
           y = 200, yend = 1000,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - Douglas Fir",
       caption = "Black dotted lines show drought stress point per individual (inflection point)\nYellow dotted line shows average drought stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PIEN
Phase1_Data_Weight_PIEN <- Phase1_Data_Weight %>% 
  filter(Species == "PIEN")

Phase1_Data_Weight_PIEN %>% 
  ggplot(aes(x = Week,
             y = Weight_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(200, 1000) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 200, yend = 1000,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Weight_PIEN$Stress_Week, 
           xend = Phase1_Data_Weight_PIEN$Stress_Week,
           y = 200, yend = 1000,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Weight_PIEN$Stress_Week_Avg,
           xend = Phase1_Data_Weight_PIEN$Stress_Week_Avg,
           y = 200, yend = 1000,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Total Weight (g)") +
  labs(title = "Weights - Engelman Spruce",
       caption = "Black dotted lines show drought stress point per individual (inflection point)\nYellow dotted line shows average drought stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()

```

### Spaghetti Plot (Drought)
```{r}
# PIFL 16 is weird

Phase1_Data_Weight %>% 
  filter(Treatment_water == "Drought", Treatment_temp == "Ambient") %>% 
  #filter(Species == "PIFL") %>% 
  #filter(SpeciesID != "PIFL16") %>% 
  ggplot(aes(x = Week,
             y = WaterWeight_Calc,
             color = SpeciesID)) +
  geom_point() +
  geom_line() +
  # annotate("rect",
  #          xmin = 7, xmax = 8,
  #          ymin = 0, ymax = 500,
  #          color = "red",
  #          linetype = "dashed",
  #          size = 0.6,
  #          fill = "red",
  #          alpha = 0.3) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Ponderosa Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Pinyon Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Limber Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Douglas fir"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Engelman Spruce"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  ylim(0, 500) +
  xlim(0,36) +
  facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Water Weight (g)") +
  labs(title = "Water Weight of Droughted Trees") +
  theme_minimal() +
  theme(legend.position = "none")
```

### Average Weight (Drought)
```{r}
Phase1_Data_Weight_Avg %>%
  ggplot(aes(x = Week,
             y = WaterWeight_Calc,
             color = Treatment_temp)) +
  geom_point() +
  geom_line() +
  ylim(0, 500) +
  xlim(0,36) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 500,
           color = "red",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Ponderosa Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Pinyon Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Limber Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Douglas fir"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Weight_Stress_Label, CommonName == "Engelman Spruce"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin1, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_errorbar(aes(x = Week,
                    ymin = (Phase1_Data_Weight_Avg$WaterWeight_Calc - Phase1_Data_Weight_Avg$SD_Water_Avg),
                    ymax = (Phase1_Data_Weight_Avg$WaterWeight_Calc + Phase1_Data_Weight_Avg$SD_Water_Avg))) +
  geom_text(label = "Heatwave",
            x = 12, y = 500, color = "red", size = 3) +
  facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Water Weight (g)") +
  labs(title = "Water Weight of Droughted Trees") +
  theme_minimal() +
  scale_color_discrete(direction = -1) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())
```


# Conductance Graphs

### All Conductance
#### Comparing Conductance of Droughted vs Watered Indiviudals

```{r}
#Weight over time (averaged)
Phase1_Data_Porometer %>% 
  filter(Treatment_water == "Drought") %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Stress_Level)) +
  geom_point() +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.6) +
  # annotate("segment",
  #          x = Phase1_Data_Porometer$Stress_Week_Avg,
  #          xend = Phase1_Data_Porometer$Stress_Week_Avg,
  #          y = 0, yend = 600,
  #          color = "black",
  #          linetype = "dashed",
  #          size = 0.6) +
  ylim(0, 600) +
  xlim(0,36) +
  #facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Breaking Down Stomatal Conductance using Stress Levels") +
  theme_minimal()
```
```{r}
Phase1_Data_Porometer %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - All Species") +
  theme_minimal()
```

Black dotted lines show stress weeks for each individual, calculated using stress level thresholds.
Yellow dotted lines show average stress weeks for each treatment group (heatwave and ambient).
```{r}
# PIPO
Phase1_Data_Porometer_PIPO <- Phase1_Data_Porometer %>% 
  filter(Species == "PIPO")

Phase1_Data_Porometer_PIPO %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIPO$Stress_Week, 
           xend = Phase1_Data_Porometer_PIPO$Stress_Week,
           y = 0, yend = 600,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIPO$Stress_Week_Avg,
           xend = Phase1_Data_Porometer_PIPO$Stress_Week_Avg,
           y = 0, yend = 600,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - Ponderosa Pine",
       caption = "Black dotted lines show stress point per individual\nYellow dotted line shows average stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()

```

```{r}
# PIED
Phase1_Data_Porometer_PIED <- Phase1_Data_Porometer %>% 
  filter(Species == "PIED")

Phase1_Data_Porometer_PIED %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIED$Stress_Week, 
           xend = Phase1_Data_Porometer_PIED$Stress_Week,
           y = 0, yend = 600,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIED$Stress_Week_Avg,
           xend = Phase1_Data_Porometer_PIED$Stress_Week_Avg,
           y = 0, yend = 600,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - Pinyon Pine",
       caption = "Black dotted lines show stress point per individual\nYellow dotted line shows average stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PIFL
Phase1_Data_Porometer_PIFL <- Phase1_Data_Porometer %>% 
  filter(Species == "PIFL")

Phase1_Data_Porometer_PIFL %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIFL$Stress_Week, 
           xend = Phase1_Data_Porometer_PIFL$Stress_Week,
           y = 0, yend = 600,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIFL$Stress_Week_Avg,
           xend = Phase1_Data_Porometer_PIFL$Stress_Week_Avg,
           y = 0, yend = 600,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - Limber Pine",
       caption = "Black dotted lines show stress point per individual\nYellow dotted line shows average stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PSME
Phase1_Data_Porometer_PSME <- Phase1_Data_Porometer %>% 
  filter(Species == "PSME")

Phase1_Data_Porometer_PSME %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
  annotate("segment",
           x = Phase1_Data_Porometer_PSME$Stress_Week, 
           xend = Phase1_Data_Porometer_PSME$Stress_Week,
           y = 0, yend = 600,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Porometer_PSME$Stress_Week_Avg,
           xend = Phase1_Data_Porometer_PSME$Stress_Week_Avg,
           y = 0, yend = 600,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - Douglas Fir",
       caption = "Black dotted lines show stress point per individual\nYellow dotted line shows average stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}
# PIEN
Phase1_Data_Porometer_PIEN <- Phase1_Data_Porometer %>% 
  filter(Species == "PIEN")

Phase1_Data_Porometer_PIEN %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_water)) +
  geom_point() +
  ylim(0, 600) +
  xlim(0,40) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 600,
           color = "red",
           linetype = "dashed",
           size = 0.9) +
    annotate("segment",
           x = Phase1_Data_Porometer_PIEN$Stress_Week, 
           xend = Phase1_Data_Porometer_PIEN$Stress_Week,
           y = 0, yend = 600,
           color = "black",
           linetype = "dashed",
           size = 0.3) +
  annotate("segment",
           x = Phase1_Data_Porometer_PIEN$Stress_Week_Avg,
           xend = Phase1_Data_Porometer_PIEN$Stress_Week_Avg,
           y = 0, yend = 600,
           color = "yellow",
           linetype = "dashed",
           size = 0.9) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance - Engelman Spruce",
       caption = "Black dotted lines show stress point per individual\nYellow dotted line shows average stress point\nRed dotted line shows time of heatwave") +
  theme_minimal()
```

```{r}


```



### Spaghetti Plot (Drought)
```{r}
Phase1_Data_Porometer %>% 
  filter(Treatment_water == "Drought", Treatment_temp == "Ambient") %>% 
  #filter(Species == "PIFL") %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = SpeciesID)) +
  geom_point() +
  geom_line() +
  # annotate("rect",
  #          xmin = 7, xmax = 8,
  #          ymin = 0, ymax = 600,
  #          color = "red",
  #          linetype = "dashed",
  #          size = 0.6,
  #          fill = "red",
  #          alpha = 0.3) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Ponderosa Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax2),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Pinyon Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax2),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Limber Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax2),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Douglas fir"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax2),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Engelman Spruce"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax2),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  ylim(0, 600) +
  xlim(0,36) +
  facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance of Droughted Trees") +
  theme_minimal() +
  theme(legend.position = "none")
```

### Average Conductance (Drought)
```{r}
Phase1_Data_Porometer_Avg %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_temp)) +
  geom_point() +
  geom_line() +
  ylim(0, 350) +
  xlim(0,36) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 350,
           color = "red",
           linetype = "dashed",
           size = 0.4) +
  # annotate("segment",
  #          x = 0, xend = 36,
  #          y = 90, yend = 90,
  #          color = "black",
  #          linetype = "solid",
  #          size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Ponderosa Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Pinyon Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Limber Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Douglas fir"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Engelman Spruce"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_errorbar(aes(x = Phase1_Data_Porometer_Avg$Week,
                    ymin = (Phase1_Data_Porometer_Avg$Porometer_Est - Phase1_Data_Porometer_Avg$SD_Avg),
                    ymax = (Phase1_Data_Porometer_Avg$Porometer_Est + Phase1_Data_Porometer_Avg$SD_Avg))) +
  geom_text(label = "Heatwave",
            x = 12, y = 300, color = "red", size = 3) +
  facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance of Droughted Trees") +
  theme_minimal() +
  scale_color_discrete(direction = -1) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())
```
#testing with colors
```{r}
Phase1_Data_Porometer_Avg %>% 
  ggplot(aes(x = Week,
             y = Porometer_Est,
             color = Treatment_temp)) +
  geom_point() +
  geom_line() +
  ylim(0, 350) +
  xlim(0,36) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 350,
           color = "red",
           linetype = "dashed",
           size = 0.4) +
  # annotate("segment",
  #          x = 0, xend = 36,
  #          y = 90, yend = 90,
  #          color = "black",
  #          linetype = "solid",
  #          size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Ponderosa Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Pinyon Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Limber Pine"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Douglas fir"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_rect(data = subset(Porometer_Stress_Label, CommonName == "Engelman Spruce"),
           aes(xmin = Week, xmax = Week,
               ymin = ymin, ymax = ymax1),
           color = "black",
           linetype = "dashed",
           size = 0.4) +
  geom_errorbar(aes(x = Phase1_Data_Porometer_Avg$Week,
                    ymin = (Phase1_Data_Porometer_Avg$Porometer_Est - Phase1_Data_Porometer_Avg$SD_Avg),
                    ymax = (Phase1_Data_Porometer_Avg$Porometer_Est + Phase1_Data_Porometer_Avg$SD_Avg))) +
  geom_text(label = "Heatwave",
            x = 12, y = 300, color = "red", size = 3) +
  facet_wrap(~CommonName) +
  xlab("Week") +
  ylab("Stomatal Conductance") +
  labs(title = "Stomatal Conductance of Droughted Trees") +
  theme_minimal() +
  scale_color_discrete(direction = -1) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())
```


# KM Curve (Drought)

### Original
```{r}

#Kaplan Meier Survival Curve - separated by treatment
km_treatment_fit <- survfit(Surv(Week, Dead_Count)~Heatwave_graph, data = Phase1_Data)

autoplot(km_treatment_fit) +
  scale_fill_brewer(palette = "Paired") +
  scale_color_brewer(palette = "Paired") +
  scale_x_continuous(breaks = seq(0 , 36, by = 4)) +
  annotate("segment",
           x = 7, xend = 7,
           y = 0, yend = 1,
           color = "red",
           linetype = "dashed",
           size = 0.8) +
  geom_text(label = "Heatwave",
            x = 5, y = 0.78, color = "red", size = 3) +
  xlab("Weeks") +
  ylab("Survivorship") +
  labs(title = "Kaplan Meier Survival Curve:\nHeatwave Effects by Species",
       color = "Species_Treatment", fill = "Species_Treatment") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())


```

### Weight Adjusted
```{r}
km_treatment_fit_weight <- survfit(Surv(Stress_Week_Start_Avg_Weight, Dead_Count)~Heatwave_graph, data = Phase1_Data)

autoplot(km_treatment_fit_weight) +
  scale_fill_brewer(palette = "Paired") +
  scale_color_brewer(palette = "Paired") +
  xlim(0,36) +
  #scale_x_continuous(breaks = seq(0 , 32, by = 4)) +
  xlab("Weeks since Stress") +
  ylab("Survivorship") +
  labs(title = "Kaplan Meier Survival Curve:\nHeatwave Effects by Species; Adjusted for Stress Week",
       color = "Species_Treatment", fill = "Species_Treatment") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())

```

### Porometer Adjusted
```{r}
km_treatment_fit_porometer <- survfit(Surv(Stress_Week_Start_Avg_Porometer, Dead_Count)~Heatwave_graph, data = Phase1_Data)

autoplot(km_treatment_fit_porometer) +
  scale_fill_brewer(palette = "Paired") +
  scale_color_brewer(palette = "Paired") +
  xlim(0,36) +
  #scale_x_continuous(breaks = seq(0 , 32, by = 4)) +
  xlab("Weeks since Stress") +
  ylab("Survivorship") +
  labs(title = "Kaplan Meier Survival Curve:\nHeatwave Effects by Species; Adjusted for Stress Week",
       color = "Species_Treatment", fill = "Species_Treatment") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_blank())
```

